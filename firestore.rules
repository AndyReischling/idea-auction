rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ───────────── USER AUTHENTICATION ───────────── */
    match /users/{userId} {
      // authenticated users can read all profiles for leaderboard, but only write their own
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    /* username registry for uniqueness checks */
    match /usernames/{username} {
      allow read: if true;                 // public "isNameTaken" check
      allow write: if request.auth != null;
    }

    /* ───────────── OPINIONS ───────────── */
    match /opinions/{opinionId} {
      allow read: if true;                 // opinions are publicly readable
      allow write: if request.auth != null; // authenticated users can create/update opinions
    }

    /* ───────────── MARKET DATA ───────────── */
    match /market-data/{marketId} {
      allow read: if true;                 // market data is publicly readable
      allow write: if request.auth != null // authenticated users can update market data
        || (request.resource.data.source in ['bot_system', 'unified-system', 'reconciliation']);
    }

    /* ───────────── TRANSACTIONS ───────────── */
    match /transactions/{transactionId} {
      allow read: if request.auth != null; // authenticated users can read transactions
      allow write: if request.auth != null // authenticated users can create transactions
        || (request.resource.data.isBot == true)
        || (request.resource.data.metadata.source in ['bot_system', 'unified-system', 'reconciliation']);
    }

    /* ───────────── SHORT POSITIONS ───────────── */
    match /short-positions/{positionId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    /* ───────────── ADVANCED BETS ───────────── */
    match /advanced-bets/{betId} {
      allow read: if request.auth != null; // Allow authenticated users to read bets for leaderboard
      allow write: if request.auth != null; // Allow authenticated users to create/update bets
    }

    /* ───────────── USER PORTFOLIOS ───────────── */
    match /user-portfolios/{userId} {
      allow read: if request.auth != null; // Allow authenticated users to read all portfolios for leaderboard
      allow write: if request.auth != null && request.auth.uid == userId; // Only allow writing to your own portfolio
    }

    /* ───────────── BOTS ───────────── */
    match /bots/{botId} {
      allow read: if request.auth != null; // Allow authenticated users to read bot profiles for leaderboard
      allow write: if request.auth != null // Allow system to manage bots
        || (request.resource.data.isBot == true)
        || (request.resource.data.metadata.source in ['bot_system', 'unified-system']);
    }

    /* ───────────── AUTONOMOUS BOTS ───────────── */
    match /autonomous-bots/{botId} {
      allow read: if true; // Allow public reads for bots
      allow write: if true; // TEMPORARY: Allow all writes for bot creation
    }
    
    /* ───────────── BOT SUBCOLLECTIONS (for migration) ───────────── */
    match /autonomous-bots/{parentId}/bots/{botId} {
      allow read: if true; // Allow public reads for bot subcollections
      allow write: if true; // TEMPORARY: Allow all writes for bot creation
    }

    /* ───────────── BOT PORTFOLIOS ───────────── */
    match /bot-portfolios/{botId} {
      allow read: if request.auth != null; // Allow authenticated users to read bot portfolios for leaderboard
      allow write: if request.auth != null // Allow system to manage bot portfolios
        || (request.resource.data.isBot == true)
        || (request.resource.data.metadata.source in ['bot_system', 'unified-system']);
    }

    /* ───────────── BOT TRANSACTIONS ───────────── */
    match /bot-transactions/{transactionId} {
      allow read: if request.auth != null; // Allow authenticated users to read bot transactions
      allow write: if request.auth != null // Allow system to manage bot transactions
        || (request.resource.data.isBot == true)
        || (request.resource.data.metadata.source in ['bot_system', 'unified-system']);
    }

    /* ───────────── ACTIVITY FEED ───────────── */
    match /activity-feed/{activityId} {
      allow read:  if true;                // live ticker is publicly visible

      // authenticated users can write
      allow write: if request.auth != null
        || (request.resource.data.isBot == true)                     // bot payload
        || (request.resource.data.metadata.source in ['bot_system', 'reconciliation', 'migration']);
    }

    /* optional aggregated feeds */
    match /global-activity-feed/{id} {
      allow read:  if true;
      allow write: if request.auth != null;
    }

    match /user-activity-feeds/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    /* ───────────── BOT SETTINGS ───────────── */
    match /bot-settings/{settingId} {
      allow read: if request.auth != null; // Allow authenticated users to read bot settings
      allow write: if request.auth != null; // Allow authenticated users to manage bot settings
    }

    /* ───────────── ADMIN COLLECTIONS ───────────── */
    match /admin/{document=**} {
      allow read, write: if request.auth != null && request.auth.token.admin == true;
    }

    /* ───────────── SYSTEM COLLECTIONS ───────────── */
    match /system/{document=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }

    /* ───────────── PUBLIC LEADERBOARD ───────────── */
    match /public-leaderboard/{document=**} {
      allow read: if true;  // Public read access for top 5 traders
      allow write: if request.auth != null; // Only authenticated users can update
    }
  }
}
