rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ───────────── USER AUTHENTICATION ───────────── */
    match /users/{userId} {
      // users may read & write only their own profile
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    /* username registry for uniqueness checks */
    match /usernames/{username} {
      allow read: if true;                 // public "isNameTaken" check
      allow write: if request.auth != null;
    }

    /* ───────────── OPINIONS ───────────── */
    match /opinions/{opinionId} {
      allow read: if true;                 // opinions are publicly readable
      allow write: if request.auth != null; // authenticated users can create/update opinions
    }

    /* ───────────── MARKET DATA ───────────── */
    match /market-data/{marketId} {
      allow read: if true;                 // market data is publicly readable
      allow write: if request.auth != null // authenticated users can update market data
        || (request.resource.data.source in ['bot_system', 'unified-system', 'reconciliation']);
    }

    /* ───────────── TRANSACTIONS ───────────── */
    match /transactions/{transactionId} {
      allow read: if request.auth != null; // authenticated users can read transactions
      allow write: if request.auth != null // authenticated users can create transactions
        || (request.resource.data.isBot == true)
        || (request.resource.data.metadata.source in ['bot_system', 'unified-system', 'reconciliation']);
    }

    /* ───────────── SHORT POSITIONS ───────────── */
    match /short-positions/{positionId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    /* ───────────── USER PORTFOLIOS ───────────── */
    match /user-portfolios/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    /* ───────────── ACTIVITY FEED ───────────── */
    match /activity-feed/{activityId} {
      allow read:  if true;                // live ticker is publicly visible

      // authenticated users can write
      allow write: if request.auth != null
        || (request.resource.data.isBot == true)                     // bot payload
        || (request.resource.data.metadata.source in ['bot_system', 'reconciliation', 'migration']);
    }

    /* optional aggregated feeds */
    match /global-activity-feed/{id} {
      allow read:  if true;
      allow write: if request.auth != null;
    }

    match /user-activity-feeds/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    /* ───────────── ADMIN COLLECTIONS ───────────── */
    match /admin/{document=**} {
      allow read, write: if request.auth != null && request.auth.token.admin == true;
    }

    /* ───────────── SYSTEM COLLECTIONS ───────────── */
    match /system/{document=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }
  }
}
